#!/usr/bin/env bash
#
# Based Claude v2 - CLI Entry Point
# Context-anchored memory layer for Claude Code
#
set -euo pipefail

# Resolve symlinks to find actual install location
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SDK_ROOT="$(cd -P "$(dirname "$SOURCE")/.." && pwd)"

# Single-source version from package.json
SDK_VERSION=$(grep '"version"' "$SDK_ROOT/package.json" | head -1 | sed 's/.*"version": *"//;s/".*//')

# Source common utilities
source "$SDK_ROOT/cli/lib/common.sh"

#───────────────────────────────────────────────────────────────────────────────
# Usage
#───────────────────────────────────────────────────────────────────────────────
usage() {
    cat <<EOF
Based Claude v${SDK_VERSION}

Context-anchored memory layer for Claude Code.
Four anchors keep Claude oriented: CLAUDE.md, Generated Skills, @claude Headers, markdown context.

USAGE:
    based-claude <command> [options]

COMMANDS:
    init        Initialize CLAUDE.md in current project
    context     Manage markdown context synced with code
    doctor      Validate installation and check for drift
    list        Show installed skills
    sync        Deprecated (use plugin marketplace commands)

OPTIONS:
    -h, --help      Show this help message
    -v, --version   Show version

WORKFLOW:
    1. Run: based-claude init
    2. Tell Claude: "annotate this codebase"
    3. Claude will:
       - Add @claude headers to key files (with USED_BY for blast radius)
       - Generate domain-specific skills in .claude/skills/
       - Complete the atlas in CLAUDE.md

    Then when working:
    - Claude reads CLAUDE.md (auto-loaded)
    - Invokes generated skills for domain-specific context
    - Checks @claude headers for blast radius before modifying files

EXAMPLES:
    # Initialize in current project
    based-claude init

    # Reverse-scaffold docs from an existing codebase
    based-claude context scaffold

    # Sync markdown function docs with latest code changes
    based-claude context sync

    # Check installation health
    based-claude doctor

For more information: https://github.com/anthropics/based-claude

EOF
}

#───────────────────────────────────────────────────────────────────────────────
# Version
#───────────────────────────────────────────────────────────────────────────────
version() {
    echo "based-claude version $SDK_VERSION"
}

#───────────────────────────────────────────────────────────────────────────────
# Main command dispatcher
#───────────────────────────────────────────────────────────────────────────────
main() {
    local cmd="${1:-}"
    shift || true

    case "$cmd" in
        init)
            source "$SDK_ROOT/cli/init.sh"
            cmd_init "$@"
            ;;
        doctor)
            source "$SDK_ROOT/cli/doctor.sh"
            cmd_doctor "$@"
            ;;
        context)
            source "$SDK_ROOT/cli/context.sh"
            cmd_context "$@"
            ;;
        list)
            source "$SDK_ROOT/cli/list.sh"
            cmd_list "$@"
            ;;
        sync)
            source "$SDK_ROOT/cli/sync.sh"
            cmd_sync "$@"
            ;;
        -h|--help|"")
            usage
            ;;
        -v|--version)
            version
            ;;
        *)
            error "Unknown command: $cmd"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
